<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestor de Inventario</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body { margin:0; font-family: 'Segoe UI', Arial, sans-serif; background: #eef2fb; }
        header { background: #446ccc; color: #fff; padding: 1.5em 2em; box-shadow: 0 2px 8px #2235; }
        .container { max-width: 480px; margin: 2.5em auto; background: #fff; border-radius: 14px; box-shadow: 0 2px 16px #446ccc20; padding: 2em 2.5em; }
        h1, h2 { text-align: center; margin-top: 0; }
        .form-row { margin: 1.5em 0 .7em 0; display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: .3em; }
        input[type="text"], input[type="email"] { padding: 10px; border-radius: 7px; border: 1px solid #bbc6e6; font-size: 1em; }
        button, .dropdown-btn {
            background: #446ccc; color: #fff; border: none; border-radius: 7px; padding: 10px 0;
            font-size: 1.1em; font-weight: 600; margin-top: 1.1em; cursor: pointer; transition: background .2s;
        }
        button:disabled { background: #bbc6e6 !important; cursor: not-allowed; }
        button:hover, .dropdown-btn:hover { background: #264499; }
        .dropdown { margin: 2em 0 0 0; }
        .dropdown-btn { width: 100%; text-align: left; position: relative; }
        .dropdown-btn:after {
            content: "▼"; position: absolute; right: 15px; top: 12px; font-size: .9em;
        }
        .dropdown-content {
            margin-top: 8px;
            background: #f7faff; border-radius: 8px; box-shadow: 0 2px 10px #446ccc10;
            padding: 2em 1.6em 1em 1.6em;
            display: none;
            animation: fadeIn .4s;
        }
        .dropdown.open .dropdown-content { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .status-label { font-size: .98em; margin: 8px 0; padding: 6px 0; }
        .imported { color: #2d8a2d; font-weight: bold; }
        .waiting { color: #978c24; }
        .error { color: #a22; }
        .flex { display: flex; gap: 8px; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1.2em; }
        .btn-group button { flex: 1 1 40%; }
        .small { font-size: .88em; color: #888; }
        .center { text-align: center; }
        .alert { font-weight: bold; padding: 4px 8px; border-radius: 6px; display: inline-block; }
        /* Las clases de alerta solo se usan en el dashboard ahora, pero las dejo por si acaso */
        .urgente { background: #ff6464; color: #222; }
        .critico { background: #ffbc64; color: #222; }
        .bajo { background: #ffff64; color: #222; }
        .optimo { background: #64ff64; color: #222; }
        .lento { background: #cccccc; color: #222; }
        .sinventas { background: #b4b4b4; color: #222; }
    </style>
</head>
<body>
    <header>
        <h1>Gestor de Inventario</h1>
    </header>
    <div class="container" id="registerContainer">
        <h2>Registro</h2>
        <div class="form-row">
            <label for="regEmail">Correo electrónico</label>
            <input type="email" id="regEmail" placeholder="ejemplo@dominio.com" required>
        </div>
        <div class="form-row">
            <label for="regNombre">Tu nombre</label>
            <input type="text" id="regNombre" placeholder="Nombre completo" required>
        </div>
        <button onclick="registrarUsuario()">Crear perfil</button>
    </div>

    <div class="container" id="userformContainer" style="display:none;">
        <div class="center small" id="perfilInfo"></div>
        <div class="dropdown" id="userDropdown">
            <button class="dropdown-btn" onclick="toggleDropdown()">Abrir gestor de cliente</button>
            <div class="dropdown-content">
                <div class="form-row">
                    <label for="nombreClienteInput">Nombre de cliente</label>
                    <input type="text" id="nombreClienteInput" placeholder="Introduce el nombre del cliente">
                </div>
                <div id="labelCliente" class="status-label waiting">Introduce el nombre del cliente</div>
                <div class="flex">
                    <button onclick="establecerNombreCliente()" style="flex:2;">Establecer Nombre</button>
                    <button onclick="limpiarFormulario()" style="flex:1;">Limpiar</button>
                </div>
                <div class="status-label waiting" id="labelInv">
                    Esperando Inventario...
                    <input type="file" id="fileInventario" accept=".xlsx,.xls,.csv" style="display:none;">
                    <button id="btnImportInv" onclick="document.getElementById('fileInventario').click()" disabled>Importar Inventario</button>
                </div>
                <div class="status-label waiting" id="labelVentas">
                    Esperando Ventas...
                    <input type="file" id="fileVentas" accept=".xlsx,.xls,.csv" style="display:none;">
                    <button id="btnImportVentas" onclick="document.getElementById('fileVentas').click()" disabled>Importar Ventas</button>
                </div>
                <div class="status-label waiting" id="labelComp">
                    Esperando Comparativa...
                    <input type="file" id="fileComparativa" accept=".xlsx,.xls,.csv" style="display:none;">
                    <button id="btnImportComp" onclick="document.getElementById('fileComparativa').click()" disabled>Importar Comparativa</button>
                </div>
                <div class="btn-group">
                    <button id="btnProcesar" onclick="procesarDatos()" disabled>Procesar Datos</button>
                    <button onclick="abrirDashboard()" disabled id="btnDashboard">Abrir Dashboard</button>
                    <button onclick="salir()" style="background:#b44;">Salir</button>
                </div>
            </div>
        </div>
        </div>
    <footer class="center" style="margin:3em 0 1em 0;">
        &copy; <span id="year"></span> - Gestor de Inventario - Adaptado de VBA a Web
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        // --- Estado global ---
        let perfil = null;
        let nombreClienteActual = "Sin nombre de cliente"; // Variable para el nombre del cliente

        // Datos subidos
        let inventario = [], ventas = [], comparativa = [];
        let invImport = false, ventasImport = false, compImport = false;

        function registrarUsuario() {
            const email = document.getElementById('regEmail').value.trim();
            const nombre = document.getElementById('regNombre').value.trim();
            if (!email || !nombre) {
                Swal.fire('Error', 'Por favor, introduce tu correo y nombre.', 'error');
                return;
            }
            perfil = { email, nombre };
            document.getElementById('registerContainer').style.display = 'none';
            document.getElementById('userformContainer').style.display = '';
            document.getElementById('perfilInfo').innerHTML =
                `<b>Bienvenido/a, ${nombre}</b> <br><span class="small">${email}</span>`;
            limpiarFormulario();
        }

        function toggleDropdown() {
            document.getElementById('userDropdown').classList.toggle('open');
        }

        function establecerNombreCliente() {
            const inputNombre = document.getElementById('nombreClienteInput').value.trim();
            if (inputNombre === "") {
                nombreClienteActual = "Sin nombre de cliente";
                mostrarMsg('labelCliente', 'Nombre de cliente: No especificado', 'waiting');
            } else {
                nombreClienteActual = inputNombre;
                mostrarMsg('labelCliente', "Nombre de Cliente: " + nombreClienteActual, 'imported');
            }
            habilitarBotones(true);
        }

        function habilitarBotones(activo) {
            document.getElementById('btnImportInv').disabled = !activo;
            document.getElementById('btnImportVentas').disabled = !activo;
            document.getElementById('btnImportComp').disabled = !activo;
            document.getElementById('btnProcesar').disabled = true;
            document.getElementById('btnDashboard').disabled = true; // Botón de dashboard
            mostrarMsg('labelInv', 'Esperando Inventario...', 'waiting');
            mostrarMsg('labelVentas', 'Esperando Ventas...', 'waiting');
            mostrarMsg('labelComp', 'Esperando Comparativa...', 'waiting');
            inventario = []; ventas = []; comparativa = [];
            invImport = ventasImport = compImport = false;
        }

        function limpiarFormulario() {
            document.getElementById('nombreClienteInput').value = '';
            nombreClienteActual = "Sin nombre de cliente";
            mostrarMsg('labelCliente', 'Introduce el nombre del cliente', 'waiting');
            mostrarMsg('labelInv', 'Esperando Inventario...', 'waiting');
            mostrarMsg('labelVentas', 'Esperando Ventas...', 'waiting');
            mostrarMsg('labelComp', 'Esperando Comparativa...', 'waiting');
            document.getElementById('btnImportInv').disabled = true;
            document.getElementById('btnImportVentas').disabled = true;
            document.getElementById('btnImportComp').disabled = true;
            document.getElementById('btnProcesar').disabled = true;
            document.getElementById('btnDashboard').disabled = true;
            inventario = []; ventas = []; comparativa = false;
            invImport = ventasImport = compImport = false;
        }

        function mostrarMsg(id, txt, tipo) {
            let el = document.getElementById(id);
            el.childNodes[0].textContent = txt;
            el.className = 'status-label ' + tipo;
        }

        // --- Importación real de archivos ---
        document.getElementById('fileInventario').addEventListener('change', e => {
            leerArchivo(e.target.files[0], data => {
                inventario = data;
                invImport = true;
                mostrarMsg('labelInv', 'Inventario: Importado', 'imported');
                checkArchivosImportados();
            });
        });
        document.getElementById('fileVentas').addEventListener('change', e => {
            leerArchivo(e.target.files[0], data => {
                ventas = data;
                ventasImport = true;
                mostrarMsg('labelVentas', 'Ventas: Importadas', 'imported');
                checkArchivosImportados();
            });
        });
        document.getElementById('fileComparativa').addEventListener('change', e => {
            leerArchivo(e.target.files[0], data => {
                comparativa = data;
                compImport = true;
                mostrarMsg('labelComp', 'Comparativa: Importada', 'imported');
                checkArchivosImportados();
            });
        });

        function leerArchivo(file, cb) {
            if (!file) {
                Swal.fire('Atención', 'No se seleccionó ningún archivo.', 'warning');
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    let data = new Uint8Array(e.target.result);
                    let workbook = XLSX.read(data, {type: 'array'});
                    let sheet = workbook.Sheets[workbook.SheetNames[0]];
                    cb(XLSX.utils.sheet_to_json(sheet, {header:1}));
                } catch (error) {
                    Swal.fire('Error', 'No se pudo leer el archivo. Asegúrate de que sea un archivo Excel o CSV válido.', 'error');
                }
            };
            reader.onerror = () => {
                Swal.fire('Error', 'Hubo un problema al leer el archivo.', 'error');
            };
            reader.readAsArrayBuffer(file);
        }

        function checkArchivosImportados() {
            if (invImport && ventasImport && compImport) {
                document.getElementById('btnProcesar').disabled = false;
            }
        }

        function procesarDatos() {
            if (!(invImport && ventasImport && compImport)) {
                Swal.fire('Atención', 'Debes importar Inventario, Ventas y Comparativa para procesar los datos.', 'warning');
                return;
            }

            mostrarMsg('labelCliente', 'Procesando datos... Por favor, espere.', 'waiting');
            setTimeout(() => {
                // Preparamos los datos para el dashboard
                const processedData = calcularDatosParaDashboard(inventario, ventas, comparativa, nombreClienteActual);

                // Guardamos los datos en localStorage
                localStorage.setItem('dashboardData', JSON.stringify(processedData));
                localStorage.setItem('nombreClienteDashboard', nombreClienteActual);

                mostrarMsg('labelCliente', 'Datos procesados exitosamente. El Dashboard está listo.', 'imported');
                document.getElementById('btnDashboard').disabled = false;
                Swal.fire('¡Éxito!', 'Datos procesados exitosamente. Ahora puedes abrir el Dashboard.', 'success');
            }, 900);
        }

        // Esta función calcula todos los datos necesarios para el dashboard
        function calcularDatosParaDashboard(inventario, ventas, comparativa, nombreCliente) {
            let totalRefs = inventario.length - 1;
            let valorInventario = 0, stockMuerto = 0, stockCritico = 0, ventasNeto = 0, ventasTotalesComp = 0, margenTotal = 0, contadorMargen = 0;
            let recs = [];
            let ventasArray = []; // Para el gráfico de ventas

            const IDX = { COD: 0, DESC: 1, STOCK: 2, COSTE: 3, VENTA: 4 };
            let ventasMap = {}, compMap = {};

            ventas.slice(1).forEach(row => {
                if (row[0]) ventasMap[row[0]] = Number(row[2]) || 0; // Código y cantidad vendida
            });
            comparativa.slice(1).forEach(row => {
                 if (row[0]) compMap[row[0]] = Number(row[2]) || 0; // Código y cantidad total en el mercado
            });

            let statusCount = { sano:0, critico:0, muerto:0, bajo:0, sinventas:0 };

            inventario.slice(1).forEach(row => {
                let stock = Number(row[IDX.STOCK]) || 0;
                let coste = Number(row[IDX.COSTE]) || 0;
                let venta = Number(row[IDX.VENTA]) || 0;
                let ventasCliente = ventasMap[row[IDX.COD]] || 0;
                let ventasMercado = compMap[row[IDX.COD]] || 0;

                valorInventario += stock * coste;

                if (stock === 0) {
                    stockMuerto++;
                    if (ventasCliente === 0) statusCount.muerto++; // Realmente muerto si no hay stock ni ventas
                }
                if (stock > 0 && stock < 5) { stockCritico++; statusCount.critico++; }
                if (ventasCliente === 0) statusCount.sinventas++;
                if (stock >= 5 && ventasCliente > 0) statusCount.sano++; // Esto es una simplificación, podrías querer más lógica aquí

                ventasNeto += ventasCliente * venta;
                ventasArray.push({ cod: row[IDX.COD], ventas: ventasCliente }); // Guardar para el gráfico de ventas

                if (venta > 0) {
                    margenTotal += (venta - coste) / venta;
                    contadorMargen++;
                }

                let alertClass = '', alertLabel = '';
                if (ventasCliente === 0)     { alertClass = 'sinventas'; alertLabel = '❌ SIN VENTAS'; }
                else if (stock === 0) {
                    if (ventasCliente >= 10)   { alertClass = 'urgente'; alertLabel = '🔴 URGENTE'; }
                    else if (ventasCliente >= 3){ alertClass = 'critico'; alertLabel = '🟠 CRÍTICO'; }
                    else                      { alertClass = 'bajo'; alertLabel = '🟡 BAJO STOCK'; }
                }
                else if (stock < 3 && ventasCliente > 0) { alertClass = 'bajo'; alertLabel = '🟡 BAJO STOCK'; }
                else if (ventasCliente / (stock || 1) > 3) { alertClass = 'optimo'; alertLabel = '✔️ ÓPTIMO'; }
                else if (ventasCliente < 2)           { alertClass = 'lento'; alertLabel = 'ℹ️ LENTO'; }
                else                                 { alertClass = 'optimo'; alertLabel = '✔️ ÓPTIMO'; }

                recs.push({
                    cod: row[IDX.COD],
                    desc: row[IDX.DESC] || 'N/A',
                    stock,
                    coste: coste.toFixed(2),
                    venta: venta.toFixed(2),
                    ventasCliente,
                    ventasMercado,
                    alertClass,
                    alertLabel
                });
            });

            // Calcular ventas totales del mercado (asumiendo que comparativa[col 2] es cantidad y comparativa[col 3] es precio de venta)
            ventasTotalesComp = comparativa.slice(1).reduce((sum, row) => sum + (Number(row[2] || 0) * Number(row[3] || 0)), 0);

            let kpis = {
                totalRefs,
                valorInventario: valorInventario.toFixed(2),
                ventasNeto: ventasNeto.toFixed(2),
                stockMuerto,
                stockCritico,
                cuota: ventasTotalesComp ? (ventasNeto / ventasTotalesComp * 100).toFixed(2) + "%" : "N/A",
                margen: contadorMargen ? (margenTotal / contadorMargen * 100).toFixed(2) + "%" : "N/A"
            };

            // Ordenar ventasArray para el top 10
            ventasArray.sort((a, b) => b.ventas - a.ventas);
            const top10VentasLabels = ventasArray.slice(0, 10).map(item => item.cod);
            const top10VentasData = ventasArray.slice(0, 10).map(item => item.ventas);

            return {
                nombreCliente: nombreCliente,
                kpis: kpis,
                recs: recs,
                statusCount: statusCount,
                top10VentasLabels: top10VentasLabels,
                top10VentasData: top10VentasData,
                margenNumerico: contadorMargen ? (margenTotal / contadorMargen * 100) : 0
            };
        }

        function abrirDashboard() {
            // Se asume que los datos ya están en localStorage desde procesarDatos()
            window.open('dashboard.html', '_blank'); // Abre el dashboard en una nueva pestaña
        }

        function salir() {
            Swal.fire({
                title: '¿Cerrar sesión?',
                text: "¿Seguro que quieres salir y cerrar sesión? Se borrarán los datos importados.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, salir',
                cancelButtonText: 'No, cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    perfil = null;
                    localStorage.removeItem('dashboardData'); // Limpiar datos del dashboard
                    localStorage.removeItem('nombreClienteDashboard'); // Limpiar el nombre del cliente
                    document.getElementById('registerContainer').style.display = '';
                    document.getElementById('userformContainer').style.display = 'none';
                    limpiarFormulario();
                    Swal.fire('¡Hasta pronto!', 'Has cerrado sesión correctamente.', 'success');
                }
            });
        }
    </script>
</body>
</html>
